2020年5月21日 21:09:08

### 目录

1. 网络层概述
2. 网际协议 IP
3. 划分子网和构造超网
4. 网际控制报文协议 ICMP
5. 因特网的路由选择协议
6. IP 多播
7. 虚拟专用网 VPN 和网络地址转换 NAT

### 1. 网络层概述

#### 1.1 网络层提供服务

历史争论：面向连接的稳定的服务或无连接尽最大努力的服务。根据电话网特点，一但线路联通，就是稳定的，所以网络层联通后也要是稳定的。由于终端的不一样，电脑比电话智能且复杂，电脑可以控制错误，还有一点网络上的终端不是单一的，有很多异构网络和异构设备，所以采用无连接的最好。

面向连接需要建立虚电路

从而把面向连接推给了上层即运输层。

#### 1.2 网络层特点

网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。

网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。

网络层不提供服务质量的承诺。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。 

### 2. 网际协议 IP

#### 2.1 网络层协议架构

网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一。与 IP 协议配套使用的还有三个协议：

地址解析协议 ARP  (Address Resolution Protocol)

网际控制报文协议 ICMP  (Internet Control Message Protocol)

网际组管理协议 IGMP  (Internet Group Management Protocol)

需要注意，IP协议使用了ARP协议，而ICMP和IGMP使用了IP协议。

![image-20200521212508086](C:\code\github\java-interview\img\ip-1.png)

#### 2.2 网络中间件

中间设备又称为中间系统或中继(relay)系统。

物理层中继系统：转发器(repeater)。

数据链路层中继系统：网桥或桥接器(bridge)。

网络层中继系统：路由器(router)。

网桥和路由器的混合物：桥路器(brouter)。

网络层以上的中继系统：网关(gateway)（由于历史的原因，许多有关 TCP/IP 的文献将网络层使用的路由器称为网关。  ）

#### 2.3 虚拟互联网络

虽然网络各终端使用了物理设备连接在一起，但是这对于软件系统是不可见和不可操作管理的，我们就需要一个软网络即虚拟互联网络。

所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络。

使用 IP 协议的虚拟互连网络可简称为 IP 网，使用虚拟互连网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。

#### 2.4 分类的 IP 地址

每一类地址都由两个固定长度的字段组成，其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络，而另一个字段则是主机号 host-id，它标志该主机（或路由器）。

​					IP 地址 ::= { <网络号>, <主机号>}    

![image-20200521213200132](C:\code\github\java-interview\img\ip-2.png)

![image-20200521213253936](C:\code\github\java-interview\img\ip-3.png)

好处：方便管理、方便路由寻表（只要配对网络号即可）

#### 2.5 IP 地址与 MAC 地址

一个物理硬件地址与硬件绑定，一个是逻辑软件地址由程序系统设定。

IP层抽象的互联网屏蔽了下层很复杂的细节，在抽象的网络层上讨论问题，就能够使用统一的、抽象的 IP 地址研究主机和主机或主机和路由器之间的通信。

#### 2.6 地址解析协议 ARP

![image-20200521213639671](C:\code\github\java-interview\img\ip-4.png)

IP 协议利用ARP协议找到MAC地址。

不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。  

网络层到数据链路层即数据报被封装为数据帧，就需要MAC地址来传递，所以知道了对方的IP地址，必须要找到对方的MAC地址，才能在下层传输。

每一个主机都设有一个 ARP 高速缓存(ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。

当没有该MAC地址时，ARP会广播找MAC，对方端响应后单播发给ARP并保存。

#### 2.7 为什么不能直接用MAC地址通信？

由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事。

连接到因特网的主机都拥有统一的 IP 地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为调用 ARP 来寻找某个路由器或主机的硬件地址都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的。

#### 2.8 IP 协议数据报格式

![image-20200521214321574](C:\code\github\java-interview\img\ip-5.png)

### 3. 划分子网和构造超网

#### 3.1 三级IP地址

划分子网就是从主机号借用若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位。 

​				IP地址 ::= {<网络号>, <子网号>, <主机号>}       

#### 3.2 子网掩码

从一个 IP 数据报的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分。使用子网掩码(subnet mask)可以找出 IP 地址中的子网部分

![image-20200521214844522](C:\code\github\java-interview\img\ip-6.png)

#### 3.3 无分类编址 CIDR

IP地址 ::= {<网络前缀>, <主机号>}      

128.14.32.0/20 表示的地址块共有 212 个地址（因为斜线后面的 20 是网络前缀的位数，所以这个地址的主机号是 12 位）。

这个地址块的起始地址是 128.14.32.0。

在不需要指出地址块的起始地址时，也可将这样的地址块简称为“/20 地址块”。

128.14.32.0/20 地址块的最小地址：128.14.32.0

128.14.32.0/20 地址块的最大地址：128.14.47.255

全 0 和全 1 的主机号地址一般不使用。

### 4. 网际控制报文协议 ICMP

#### 4.1 定义

为了提高 IP 数据报交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。

ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。ICMP 不是高层协议，而是 IP 层的协议。

ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去。  

#### 4.2 应用

PING (Packet InterNet Groper) 使用了 ICMP 回送请求与回送回答报文。是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP。 

Traceroute （tracert）命令用来列出中间经过的所有IP地址，通过TTL设置跳转数字来确定1，2等。

### 5. 因特网的路由选择协议

#### 5.1 两大类路由选择协议 

n内部网关协议 IGP (Interior Gateway Protocol)  即在一个自治系统内部使用的路由选择协议。目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议。

n外部网关协议EGP (External Gateway Protocol)  若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议 EGP。在外部网关协议中目前使用最多的是 BGP-4。 

#### 5.2 内部网关协议 RIP (Routing Information Protocol)

n路由信息协议 RIP 是内部网关协议 IGP中最先得到广泛使用的协议。

nRIP 是一种分布式的基于距离向量的路由选择协议。

nRIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。 

#### 5.3 内部网关协议 OSPF (Open Shortest Path First)

n“开放”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的。

n“最短路径优先”是因为使用了 Dijkstra 提出的最短路径算法SPF

nOSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。

n是分布式的链路状态协议。 

#### 5.4 外部网关协议 BGP

n因特网的规模太大，使得自治系统之间路由选择非常困难。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。

n当一条路径通过几个不同 AS 时，要想对这样的路径计算出有意义的代价是不太可能的。

n比较合理的做法是在 AS 之间交换“可达性”信息。  

n自治系统之间的路由选择必须考虑有关策略。

n因此，边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。 

### 6. IP 多播

多播使用组地址—— IP 使用 D 类地址支持多播。多播地址只能用于目的地址，而不能用于源地址。 

(2) 永久组地址——由因特网号码指派管理局 IANA 负责指派。

(3) 动态的组成员 

(4) 使用硬件进行多播

为了使路由器知道多播组成员的信息，需要利用网际组管理协议 IGMP (Internet Group Management Protocol)。

连接在局域网上的多播路由器还必须和因特网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员。这就需要使用多播路由选择协议。 

### 7. 虚拟专用网 VPN 和网络地址转换 NAT

本地地址——仅在机构内部使用的 IP 地址，可以由本机构自行分配，而不需要向因特网的管理机构申请。

全球地址——全球唯一的IP地址，必须向因特网的管理机构申请。 

网络地址转换 NAT (Network Address Translation)